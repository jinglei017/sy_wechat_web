<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>新增合作商-联系人</title>
    <link rel="stylesheet" type="text/css" href="css/common.css" />
    <link rel="stylesheet" type="text/css" href="css/newFromToItBa.css" />
</head>
<body>

<div class="header">
    <a href="javascript:;" class="returnBtn" id="goBeforePage"></a>
    <p class="txt">新增合作商-联系人</p>
    <b class="right"></b>
</div>
<div class="content newPartyMain" id="newOrderApp">
    <div class="orderInf parcelInf">
        <ul v-for="(partyContact,index) in partyContactlList" class="adsRightConInp">
            <li class="newPartyLi">
                <span class="txt"><span class="color_r">*&nbsp;</span>联系人类型</span>
                <p class="inp">
                    <select v-model="partyContact.contactType" name="">
                        <option value="">请选择</option>
                        <option v-for="contactTypeItem in selectListData.contactLists" v-bind:value="contactTypeItem.code">{{contactTypeItem.text}}</option>
                    </select>
                </p>
            </li>
            <li class="newPartyLi">
                <span class="txt"><span class="color_r">*&nbsp;</span>姓名</span>
                <p class="inp">
                    <input type="text" v-model="partyContact.contactName" placeholder="姓名" />
                </p>
            </li>
            <li class="newPartyLi">
                <span class="txt"><span class="color_w">*&nbsp;</span>电话</span>
                <p class="inp">
                    <input type="text" v-model="partyContact.contactTel" placeholder="电话" />
                </p>
            </li>
            <li class="newPartyLi">
                <span class="txt"><span class="color_w">*&nbsp;</span>邮箱</span>
                <p class="inp">
                    <input type="text" v-model="partyContact.contactEmail" placeholder="邮箱" />
                </p>
            </li>
            <li class="newPartyLi">
                <span class="txt"><span class="color_w">*&nbsp;</span>地址</span>
                <p class="inp">
                    <input type="text" v-model="partyContact.contactAddress" placeholder="地址" />
                </p>
            </li>
            <li class="newPartyLi">
                <span class="txt"><span class="color_w">*&nbsp;</span>备注</span>
                <p class="inp">
                    <input type="text" v-model="partyContact.remark" placeholder="备注" />
                </p>
            </li>
            <li class="newPartyLi">
                <span class="txt"><span class="color_r">*&nbsp;</span>是否默认</span>
                <p class="inp">
                    <select v-model="partyContact.isDefault" name="">
                        <option value="">请选择</option>
                        <option value="1">是</option>
                        <option value="0">否</option>
                    </select>
                </p>
            </li>
            <li class="operationItem" style="display: none;">
                <span class="txt float_l" v-on:click="addConactFun()">+新增联系人</span>
                <p class="inp float_r" v-if="index != 0" v-on:click="delConactFun(index)">-删除联系人</p>
            </li>
        </ul>
    </div>

    <div class="orderBottom1">
        <a href="javascript:;" v-on:click="saveNewOrderItemsInfo()" v-if="disAbled == '1' || disAbled == '3'">保存</a>
    </div>

    <div v-if="disAbled == '0'" class="orderBottom2">请先填写保存上一页合作商基本信息，再填写联系人信息。</div>
    <div v-if="disAbled == '2'" class="orderBottom2">请先填写保存上一页合作商地址信息，再填写地址联系人信息。</div>

</div>

<script src="js/jquery-2.1.0.js" type="text/javascript"></script>
<script src="js/common.js" type="text/javascript"></script>
<script src="js/env_config.js" type="text/javascript"></script>
<script src="js/vue.js" type="text/javascript"></script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script type="text/javascript">
    document.write("<s" + "cript type='text/javascript' src='js/getlocation.js?v=" + verson + "'></s" + "cript>");
</script>
<script type="text/javascript">
    var app = new Vue({
        el: '#newOrderApp',
        data: {
            disAbled:"",
            cdPartyId:"",
            cdLocationId:"",
            selectListData:{},
            partyContactlList:[{
                contactType:"",
                contactName:"",
                contactTel:"",
                isDefault:""
            }]
        },
        methods:{
            addConactFun(){
                this.partyContactlList.push({
                    contactType:"",
                    contactName:"",
                    isDefault:""
                });
            },
            delConactFun(index){
                if(index == 0){
                    loadData('show', '第一条不可删除', true);
                }else{
                    this.partyContactlList.splice(index,1);
                }
            },
            saveNewOrderItemsInfo(){
                var that = this,hasPartyCont = [],hasLocCont = [];
                that.logininf = JSON.parse(localStorage.getItem("logininf"));
                if(that.partyContactlList.length == 0){
                    loadData('show', '当前无联系人信息', true);
                    return false;
                }
                var check = 0,defaultNum = 0,defaultObj = {},sucNum = 0;
                $.each(that.partyContactlList, function (index, item) { // 联系人类型、姓名、是否默认
                    if(item.contactType == '' || item.contactName == '' || item.isDefault == ''){
                        check += 1;
                    }
                });
                if(check != 0){
                    loadData('show', '请完整填写必填项', true);
                    return false;
                }
                $.each(that.partyContactlList, function (index, item) {
                    if(item.isDefault == 1){
                        defaultNum++;
                        defaultObj = item;
                    }
                });
                switch (getUrlParam('type'))
                {
                    case '0': // 从合作商基本信息过来的，保存为合作商下面的联系人
                        $.each(that.partyContactlList, function (index, item) {
                            item.refId = that.cdPartyId;
                            if(defaultNum != 0){
                                if(localStorage.getItem("hasPartyContDefault") == null){
                                    localStorage.setItem("hasPartyContDefault",JSON.stringify(defaultObj));
                                }else{
                                    var hasDefaultObj = JSON.parse(localStorage.getItem("hasPartyContDefault"));
                                    loadData('show','您已设置'+hasDefaultObj.contactName+'为默认联系人',true)
                                    return false;
                                }
                            }
                            postRequest(cmdUrl + "/cdContact/saveCdContact.json?token="+that.logininf.token+"&timeStamp="+that.logininf.timeStamp,item,function(data){
                                if(data != null && data.result != null){
                                    hasPartyCont.push(data.result);
                                    sucNum += 1;
                                    if(sucNum == that.partyContactlList.length){
                                        if(localStorage.getItem("hasPartyCont") != null){
                                            var oldArray = JSON.parse(localStorage.getItem("hasPartyCont"));
                                            $.each(oldArray, function (indexx, itemm) {
                                                hasPartyCont.push(itemm);
                                            });
                                        }
                                        localStorage.setItem("hasPartyCont",JSON.stringify(hasPartyCont));
                                        that.partyContactlList = [{
                                            contactType:"",
                                            contactName:"",
                                            contactTel:"",
                                            isDefault:""
                                        }];
                                        loadData('show', '保存联系人信息成功', true);
                                    }
                                }else{
                                    loadData('show', '保存联系人信息失败！', true);
                                }
                            });
                        });
                        break;
                    case '1': // 从合作商新增地址过来的，保存为合作商新增地址下面的地址联系人
                        $.each(that.partyContactlList, function (index, item) {
                            item.refId = that.cdLocationId;
                            if(defaultNum != 0){
                                if(localStorage.getItem("hasLocContDefault") != null){
                                    localStorage.setItem("hasLocContDefault",JSON.stringify(defaultObj));
                                }else{
                                    var hasDefaultObj = JSON.parse(localStorage.getItem("hasLocContDefault"));
                                    loadData('show','您已设置'+hasDefaultObj.contactName+'为默认地址联系人',true)
                                    return false;
                                }
                            }
                            postRequest(cmdUrl + "/cdContact/saveCdContact.json?token="+that.logininf.token+"&timeStamp="+that.logininf.timeStamp,item,function(data){
                                if(data != null && data.result != null){
                                    hasLocCont.push(data.result);
                                    sucNum += 1;
                                    if(sucNum == that.partyContactlList.length){
                                        if(localStorage.getItem("hasLocCont") != null){
                                            var oldArray = JSON.parse(localStorage.getItem("hasLocCont"));
                                            $.each(oldArray, function (indexx, itemm) {
                                                hasLocCont.push(itemm);
                                            });
                                        }
                                        localStorage.setItem("hasLocCont",JSON.stringify(hasLocCont));
                                        that.partyContactlList = [{
                                            contactType:"",
                                            contactName:"",
                                            contactTel:"",
                                            isDefault:""
                                        }];
                                        loadData('show', '保存地址联系人信息成功', true);
                                    }
                                }else{
                                    loadData('show', '保存地址联系人信息失败！', true);
                                }
                            });
                        });
                        break;
                }
            }
        },
        created:function(){
            var that = this;
            that.logininf = JSON.parse(localStorage.getItem("logininf"));
            that.selectListData = JSON.parse(localStorage.getItem("newOrderBasicData"));    //获取下拉数据
            if(localStorage.getItem("hasCdPartyId") != null){
                that.cdPartyId = localStorage.getItem("hasCdPartyId");
            }
            switch (getUrlParam('type'))
            {
                case '0': // 从合作商基本信息页面过来的
                    if(getUrlParam('cdPartyId') == null){
                        that.disAbled = 0;
                    }else{
                        that.disAbled = 1;
                    }
                    $(document).attr("title","新增合作商-联系人");
                    $(".header .txt").html("新增合作商-联系人");
                    break;
                case '1': // 从地址信息过来的
                    if(getUrlParam('cdLocationId') != null){
                        that.cdLocationId = getUrlParam('cdLocationId');
                        that.disAbled = 3;
                    }else{
                        that.disAbled = 2;
                    }
                    $(document).attr("title","新增地址-联系人");
                    $(".header .txt").html("新增地址-联系人");
                    break;
            }
        }
    });

    $(function () {
        // 获取当前位置
        getLocationFun();
        /* 微信中不隐去.header */
        var ua = window.navigator.userAgent.toLowerCase();
       /* if(ua.match(/MicroMessenger/i) == 'micromessenger'){
            $(".header").show();
            $(".content.newPartyMain").css({
                "marginTop":"0.88rem"
            })
        }*/

        // 返回
        $(document).on("click","#goBeforePage",function(){
            switch (getUrlParam('type'))
            {
                case '0':
                    window.location.href = "newPartyHisLists.html";
                    break;
                case '1':
                    var cdPartyId;
                    if(localStorage.getItem("hasCdPartyId") != null){
                        cdPartyId = localStorage.getItem("hasCdPartyId");
                        window.location.href = "newPartyHisListsLoc.html?from=1&cdPartyId="+cdPartyId;
                    }else{
                        window.location.href = "newPartyHisListsLoc.html?from=1";
                    }
                    break;
            }
        });
    });
</script>

</body>
</html>